name: Deploy to Google Compute Engine

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        
    - name: Setup Google Cloud CLI
      uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: tropical-cloud-detection
        
    - name: Deploy to VM
      run: |
        # Create deployment package
        tar -czf app.tar.gz --exclude='.git' --exclude='venv' --exclude='__pycache__' --exclude='*.pyc' --exclude='.env*' --exclude='db.sqlite3*' --exclude='media' --exclude='staticfiles' --exclude='key.json' --exclude='gcp-github-actions*' --warning=no-file-changed .
        
        # Upload package
        gcloud compute scp app.tar.gz tropical-cloud-app:/tmp/app.tar.gz --zone=asia-southeast1-a
        
        # Setup and install
        gcloud compute ssh tropical-cloud-app --zone=asia-southeast1-a --command="sudo mkdir -p /opt/tropical-cloud-detection"
        gcloud compute ssh tropical-cloud-app --zone=asia-southeast1-a --command="cd /opt/tropical-cloud-detection && sudo tar -xzf /tmp/app.tar.gz"
        gcloud compute ssh tropical-cloud-app --zone=asia-southeast1-a --command="sudo apt-get update && sudo apt-get install -y python3 python3-pip python3-venv nginx build-essential libhdf5-dev libnetcdf-dev pkg-config"
        gcloud compute ssh tropical-cloud-app --zone=asia-southeast1-a --command="cd /opt/tropical-cloud-detection && sudo python3 -m venv venv"
        gcloud compute ssh tropical-cloud-app --zone=asia-southeast1-a --command="cd /opt/tropical-cloud-detection && source venv/bin/activate && sudo venv/bin/pip install -r requirements.txt"
        gcloud compute ssh tropical-cloud-app --zone=asia-southeast1-a --command="cd /opt/tropical-cloud-detection && source venv/bin/activate && sudo venv/bin/python manage.py migrate"
        gcloud compute ssh tropical-cloud-app --zone=asia-southeast1-a --command="cd /opt/tropical-cloud-detection && source venv/bin/activate && sudo venv/bin/python manage.py collectstatic --noinput"
        
        # Create service files
        gcloud compute ssh tropical-cloud-app --zone=asia-southeast1-a --command="echo '[Unit]
        Description=Tropical Cloud Detection
        After=network.target
        
        [Service]
        Type=exec
        User=root
        WorkingDirectory=/opt/tropical-cloud-detection
        Environment=PATH=/opt/tropical-cloud-detection/venv/bin
        Environment=ENVIRONMENT=production
        Environment=DEBUG=False
        Environment=ALLOWED_HOSTS=localhost,127.0.0.1,35.247.130.75
        ExecStart=/opt/tropical-cloud-detection/venv/bin/gunicorn --bind 127.0.0.1:8000 --workers 4 --timeout 600 cloud_detection_portal.wsgi:application
        Restart=always
        
        [Install]
        WantedBy=multi-user.target' | sudo tee /etc/systemd/system/tropical-cloud-detection.service"
        
        gcloud compute ssh tropical-cloud-app --zone=asia-southeast1-a --command="echo 'server {
            listen 8080;
            server_name _;
            client_max_body_size 200M;
            
            location /static/ {
                alias /opt/tropical-cloud-detection/staticfiles/;
            }
            
            location /media/ {
                alias /opt/tropical-cloud-detection/media/;
            }
            
            location / {
                proxy_pass http://127.0.0.1:8000;
                proxy_set_header Host \$host;
                proxy_set_header X-Real-IP \$remote_addr;
                proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
            }
        }' | sudo tee /etc/nginx/sites-available/tropical-cloud-detection"
        
        # Start services
        gcloud compute ssh tropical-cloud-app --zone=asia-southeast1-a --command="sudo systemctl daemon-reload"
        gcloud compute ssh tropical-cloud-app --zone=asia-southeast1-a --command="sudo systemctl enable tropical-cloud-detection"
        gcloud compute ssh tropical-cloud-app --zone=asia-southeast1-a --command="sudo systemctl enable nginx"
        gcloud compute ssh tropical-cloud-app --zone=asia-southeast1-a --command="sudo ln -sf /etc/nginx/sites-available/tropical-cloud-detection /etc/nginx/sites-enabled/"
        gcloud compute ssh tropical-cloud-app --zone=asia-southeast1-a --command="sudo rm -f /etc/nginx/sites-enabled/default"
        gcloud compute ssh tropical-cloud-app --zone=asia-southeast1-a --command="sudo systemctl restart tropical-cloud-detection"
        gcloud compute ssh tropical-cloud-app --zone=asia-southeast1-a --command="sudo systemctl restart nginx"
        
    - name: Verify
      run: |
        echo "ðŸŽ‰ Deployment Complete!"
        echo "ðŸ”— App URL: http://35.247.130.75:8080" 