name: Deploy to Google Compute Engine

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup Google Cloud CLI
      uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: tropical-cloud-detection
        service_account_key: ${{ secrets.GCP_SA_KEY }}
        export_default_credentials: true
        
    - name: Deploy to VM
      run: |
        # Create deployment package
        tar -czf app.tar.gz \
          --exclude='.git' \
          --exclude='venv' \
          --exclude='__pycache__' \
          --exclude='*.pyc' \
          --exclude='.env' \
          --exclude='db.sqlite3' \
          --exclude='media/*' \
          --exclude='staticfiles/*' \
          .
        
        # Upload and deploy
        gcloud compute scp app.tar.gz tropical-cloud-app:/tmp/app.tar.gz \
          --zone=asia-southeast1-a
        
        gcloud compute ssh tropical-cloud-app \
          --zone=asia-southeast1-a \
          --command="
            set -e
            sudo mkdir -p /opt/tropical-cloud-detection
            cd /opt/tropical-cloud-detection
            sudo tar -xzf /tmp/app.tar.gz
            
            # Setup if first time
            if [ ! -d venv ]; then
              sudo apt-get update
              sudo apt-get install -y python3 python3-pip python3-venv nginx
              sudo python3 -m venv venv
            fi
            
            # Install and setup
            source venv/bin/activate
            sudo venv/bin/pip install -r requirements.txt
            sudo venv/bin/python manage.py migrate
            sudo venv/bin/python manage.py collectstatic --noinput
            
            # Start services
            sudo systemctl restart tropical-cloud-detection 2>/dev/null || echo 'Service will be created'
            sudo systemctl restart nginx 2>/dev/null || echo 'Nginx will be configured'
            
            echo 'Deployment completed!'
          "
        
    - name: Verify
      run: |
        echo 'ðŸŽ‰ Deployment Complete!'
        echo 'ðŸ”— App URL: http://35.247.130.75:8080' 