{% extends 'cloud_detection/base.html' %}

{% block title %}Dashboard - TropicalSat Cloud Detection{% endblock %}

{% block content %}
<!-- Tab Navigation -->
<div class="mb-4">
    <div class="row">
        <div class="col-12">
            <div class="d-grid gap-0 d-md-flex justify-content-md-center">
                <button class="tab-button btn flex-fill me-md-2 mb-2 mb-md-0 active" onclick="showTab('dashboard')">
                    <i class="fas fa-chart-bar me-2"></i>
                    Dashboard
                </button>
                <button class="tab-button btn flex-fill me-md-2 mb-2 mb-md-0" onclick="showTab('upload')">
                    <i class="fas fa-upload me-2"></i>
                    Upload Data
                </button>
                <button class="tab-button btn flex-fill" onclick="showTab('satellite')">
                    <i class="fas fa-satellite me-2"></i>
                    Satellite View
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Dashboard Tab Content -->
<div id="dashboard-tab" class="tab-content">
    <div class="row g-4">
        <!-- Cloud Analytics Section -->
        <div class="col-lg-9">
            <div class="card-glass rounded-4 p-4 h-100">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="text-white mb-0">
                        <i class="fas fa-cloud text-cyan-400 me-2"></i>
                        Cloud Analytics Dashboard
                    </h5>
                    <div class="d-flex gap-2">
                        <span class="badge bg-success bg-opacity-25 text-success border border-success border-opacity-25">
                            <i class="fas fa-circle fa-pulse me-1"></i>Real-time
                        </span>
                        <span class="badge bg-primary bg-opacity-25 text-primary border border-primary border-opacity-25">
                            {{ completed_files }} Files Processed
                        </span>
                    </div>
                </div>
                
                <!-- Stats Cards -->
                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <div class="p-3 rounded-3" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(6, 182, 212, 0.2)); border: 1px solid rgba(59, 130, 246, 0.3);">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <p class="text-primary-light small mb-1">Avg Coverage</p>
                                    <p class="h4 text-primary fw-bold mb-0">{{ avg_coverage }}</p>
                                </div>
                                <div class="p-2 rounded-circle" style="background: rgba(59, 130, 246, 0.3);">
                                    <i class="fas fa-chart-line text-primary"></i>
                                </div>
                            </div>
                            <div class="small text-primary-light mt-2">From {{ completed_files }} files</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="p-3 rounded-3" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(20, 184, 166, 0.2)); border: 1px solid rgba(16, 185, 129, 0.3);">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <p class="text-success-light small mb-1">Detection Rate</p>
                                    <p class="h4 text-success fw-bold mb-0">{{ detection_rate }}</p>
                                </div>
                                <div class="p-2 rounded-circle" style="background: rgba(16, 185, 129, 0.3);">
                                    <i class="fas fa-bullseye text-success"></i>
                                </div>
                            </div>
                            <div class="small text-success-light mt-2">{{ completed_files }}/{{ total_files }} successful</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="p-3 rounded-3" style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(236, 72, 153, 0.2)); border: 1px solid rgba(168, 85, 247, 0.3);">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <p class="text-purple-light small mb-1">Alerts Today</p>
                                    <p class="h4 text-purple fw-bold mb-0">{{ alerts_today }}</p>
                                </div>
                                <div class="p-2 rounded-circle" style="background: rgba(168, 85, 247, 0.3);">
                                    <i class="fas fa-exclamation-triangle text-purple"></i>
                                </div>
                            </div>
                            <div class="small text-purple-light mt-2">High cloud coverage areas</div>
                        </div>
                    </div>
                </div>
                
                <!-- Processed Files Cards -->
                <div class="mb-3">
                    <h6 class="text-white">
                        <i class="fas fa-layer-group text-cyan-400 me-2"></i>
                        Recent Analysis Results
                    </h6>
                </div>
                
                <div class="row g-3" id="analyticsCards">
                    {% for data in completed_data_cards %}
                    <div class="col-lg-4 col-md-6">
                        <div class="card bg-dark bg-opacity-30 border-0 rounded-3 overflow-hidden position-relative analytics-card" 
                             style="backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1) !important; cursor: pointer;"
                             onclick="showAnalyticsDetails({{ data.id }})">
                            
                            <!-- Thumbnail Image -->
                            <div class="position-relative">
                                {% if data.thumbnail_image %}
                                    <img src="{{ data.thumbnail_image.url }}" alt="Analysis Result" 
                                         class="card-img-top" style="height: 150px; object-fit: cover;">
                                {% else %}
                                    <div class="card-img-top d-flex align-items-center justify-content-center"
                                         style="height: 150px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(16, 185, 129, 0.3));">
                                        <i class="fas fa-satellite text-white fa-2x"></i>
                                    </div>
                                {% endif %}
                                
                                <!-- Status Badge -->
                                <div class="position-absolute top-0 end-0 m-2">
                                    <span class="badge bg-success bg-opacity-75 text-success border border-success border-opacity-50">
                                        <i class="fas fa-check me-1"></i>Completed
                                    </span>
                                </div>
                            </div>
                            
                            <!-- Card Body -->
                            <div class="card-body p-3">
                                <h6 class="card-title text-white mb-2">{{ data.file_name|truncatechars:20 }}</h6>
                                
                                <!-- Details Grid -->
                                <div class="row g-2 small">
                                    <div class="col-6">
                                        <div class="text-white-50">Location</div>
                                        <div class="text-white fw-medium">{{ data.location_name|default:"Unknown" }}</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="text-white-50">Coverage</div>
                                        <div class="text-white fw-medium">{{ data.cloud_coverage_percentage|floatformat:1 }}%</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="text-white-50">Temperature</div>
                                        <div class="text-white fw-medium">{{ data.avg_temperature|floatformat:1 }}K</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="text-white-50">Weather</div>
                                        <div class="text-white fw-medium">{{ data.weather_conditions|default:"Clear" }}</div>
                                    </div>
                                </div>
                                
                                <!-- Upload Time -->
                                <div class="mt-2 pt-2 border-top border-white border-opacity-10">
                                    <small class="text-white-50">
                                        <i class="fas fa-clock me-1"></i>
                                        {{ data.upload_datetime|timesince }} ago
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="col-12">
                        <div class="text-center py-5">
                            <i class="fas fa-cloud-upload-alt text-white-50 fa-3x mb-3"></i>
                            <h6 class="text-white-50">No analysis results yet</h6>
                            <p class="text-white-50 small">Upload your first satellite data file to see analytics here</p>
                            <button class="btn btn-glass" onclick="showTab('upload')">
                                <i class="fas fa-upload me-2"></i>Upload Data
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- Extended Real-time Data Sidebar -->
        <div class="col-lg-3">
            <div class="card-glass rounded-4 p-4 h-100">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="text-white mb-0">
                        <i class="fas fa-satellite text-cyan-400 me-2"></i>
                        Real-time Weather
                    </h6>
                    <button class="btn btn-sm btn-glass" onclick="requestLocationPermission()" id="locationBtn">
                        <i class="fas fa-location-arrow"></i>
                    </button>
                </div>
                
                <!-- Location Status -->
                <div class="mb-3 p-2 rounded" style="background: rgba(255, 255, 255, 0.05);" id="locationStatus">
                    <div class="small text-white-50">Location</div>
                    <div class="text-white small" id="locationText">Click to get your location</div>
                </div>
                
                <!-- Weather Data Grid -->
                <div class="row g-3 mb-3">
                    <div class="col-6">
                        <div class="text-center">
                            <div class="text-white-50 small">Temperature</div>
                            <div class="h5 text-white" id="weatherTemp">--°C</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center">
                            <div class="text-white-50 small">Humidity</div>
                            <div class="h5 text-white" id="weatherHumidity">--%</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center">
                            <div class="text-white-50 small">Pressure</div>
                            <div class="h5 text-white" id="weatherPressure">-- hPa</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center">
                            <div class="text-white-50 small">Wind Speed</div>
                            <div class="h5 text-white" id="weatherWind">-- km/h</div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="text-center">
                            <div class="text-white-50 small">Cloud Coverage</div>
                            <div class="h5 text-white" id="weatherClouds">--%</div>
                        </div>
                    </div>
                </div>
                
                <!-- Weather Description -->
                <div class="mb-3 p-2 rounded text-center" style="background: rgba(255, 255, 255, 0.05);">
                    <div class="text-white" id="weatherDescription">Loading...</div>
                    <div class="small text-white-50" id="weatherLocation">Waiting for location</div>
                </div>
                
                <!-- System Status -->
                <div class="mt-3 p-2 rounded" style="background: rgba(255, 255, 255, 0.05);">
                    <div class="row text-xs">
                        <div class="col-6">
                            <div class="text-white-50 small">System Status</div>
                            <div class="text-success small">{{ system_status }}</div>
                        </div>
                        <div class="col-6">
                            <div class="text-white-50 small">Accuracy</div>
                            <div class="text-success small">{{ accuracy }}</div>
                        </div>
                    </div>
                </div>
                
                <!-- Last Updated -->
                <div class="mt-3 text-center">
                    <small class="text-white-50">
                        <i class="fas fa-sync-alt me-1"></i>
                        Last updated: <span id="lastUpdated">Never</span>
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upload Tab Content -->
<div id="upload-tab" class="tab-content" style="display: none;">
    <div class="row g-4">
        <!-- File Upload -->
        <div class="col-lg-6">
            <div class="card-glass rounded-4 p-4 h-100">
                <h5 class="text-white mb-4">
                    <i class="fas fa-upload text-cyan-400 me-2"></i>
                    Upload Satellite Data
                </h5>
                
                <form method="post" enctype="multipart/form-data" action="{% url 'cloud_detection:upload_file' %}" id="uploadForm">
                    {% csrf_token %}
                    
                    <!-- Drag & Drop Area -->
                    <div class="upload-area mb-4 p-4 rounded-3 border border-dashed border-primary border-opacity-50 text-center"
                         style="background: rgba(59, 130, 246, 0.1); min-height: 200px; cursor: pointer;"
                         onclick="document.getElementById('fileInput').click()"
                         ondragover="handleDragOver(event)"
                         ondrop="handleDrop(event)">
                        <div class="upload-content">
                            <i class="fas fa-cloud-upload-alt text-primary fa-3x mb-3"></i>
                            <h6 class="text-white">Drag & Drop your satellite data file here</h6>
                            <p class="text-white-50 small">or click to browse</p>
                            <div class="small text-white-50">
                                Supported: HDF5 (.h5, .hdf5), NetCDF (.nc, .netcdf) • Max: 500MB
                            </div>
                        </div>
                    </div>
                    
                    <!-- File Input -->
                    <input type="file" name="file_path" class="d-none" id="fileInput" accept=".h5,.hdf5,.nc,.netcdf" required>
                    
                    <!-- File Info Display -->
                    <div id="fileInfo" class="mb-3" style="display: none;">
                        <div class="p-3 rounded-3 border border-success border-opacity-50" style="background: rgba(16, 185, 129, 0.1);">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-file-alt text-success me-2"></i>
                                <div>
                                    <div class="text-white small fw-medium" id="fileName"></div>
                                    <div class="text-white-50 small" id="fileSize"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div id="uploadProgress" class="mb-3" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-white small">Upload Progress</span>
                            <span class="text-white small" id="progressText">0%</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-cyan-400 progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%" id="progressBar"></div>
                        </div>
                        <div class="small text-white-50 mt-1" id="uploadStatus">Preparing upload...</div>
                    </div>
                    
                    <!-- Form Fields -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label text-white">Satellite Name</label>
                            <input type="text" name="satellite_name" class="form-control" value="INSAT-3DR" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-white">Data Type</label>
                            <select name="data_type" class="form-control" required>
                                <option value="HDF5">HDF5</option>
                                <option value="NetCDF">NetCDF</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Upload Button -->
                    <button type="button" class="btn btn-glass w-100" id="uploadBtn" onclick="handleUploadSubmit()">
                        <i class="fas fa-cloud-upload-alt me-2"></i>
                        Upload & Process
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Processing Queue & Recent Results -->
        <div class="col-lg-6">
            <div class="row g-4">
                <!-- Processing Queue -->
                <div class="col-12">
                    <div class="card-glass rounded-4 p-4">
                        <h6 class="text-white mb-3">
                            <i class="fas fa-hourglass-half text-cyan-400 me-2"></i>
                            Processing Queue
                        </h6>
                        
                        <div id="processingQueue">
                            {% if processing_queue %}
                                {% for item in processing_queue %}
                                <div class="d-flex justify-content-between align-items-center p-2 mb-2 rounded" style="background: rgba(255, 255, 255, 0.05);">
                                    <div>
                                        <div class="text-white small fw-medium">{{ item.file_name|truncatechars:20 }}</div>
                                        <div class="text-white-50 small">{{ item.upload_datetime|timesince }} ago</div>
                                    </div>
                                    <div>
                                        <span class="badge bg-warning bg-opacity-25 text-warning">
                                            <i class="fas fa-spinner fa-spin me-1"></i>Processing
                                        </span>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-center text-white-50 py-4">
                                    <i class="fas fa-inbox fs-1 mb-3 d-block"></i>
                                    <p>No files in queue</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Recent Results -->
                <div class="col-12">
                    <div class="card-glass rounded-4 p-4">
                        <h6 class="text-white mb-3">
                            <i class="fas fa-chart-line text-cyan-400 me-2"></i>
                            Recent Results
                        </h6>
                        
                        <div id="recentResults">
                            {% if recent_results %}
                                {% for data in recent_results %}
                                <div class="d-flex justify-content-between align-items-center p-2 mb-2 rounded" style="background: rgba(255, 255, 255, 0.05);">
                                    <div>
                                        <div class="text-white small fw-medium">{{ data.file_name|truncatechars:20 }}</div>
                                        <div class="text-white-50 small">{{ data.upload_datetime|timesince }} ago</div>
                                    </div>
                                    <div>
                                        <span class="badge bg-success bg-opacity-25 text-success">
                                            <i class="fas fa-check me-1"></i>Completed
                                        </span>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-center text-white-50 py-3">
                                    <p class="mb-0">No recent results</p>
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="mt-3">
                            <a href="{% url 'cloud_detection:data_history' %}" class="btn btn-glass btn-sm w-100">
                                <i class="fas fa-history me-2"></i>View All History
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Satellite View Tab Content -->
<div id="satellite-tab" class="tab-content" style="display: none;">
    <div class="row g-4">
        <!-- Satellite Map -->
        <div class="col-lg-8">
            <div class="card-glass rounded-4 p-4 h-100">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="text-white mb-0">
                        <i class="fas fa-satellite text-cyan-400 me-2"></i>
                        Satellite View
                    </h5>
                    <div class="d-flex gap-2">
                        <span class="badge bg-success bg-opacity-25 text-success border border-success border-opacity-25">Live Feed</span>
                        <span class="badge bg-primary bg-opacity-25 text-primary border border-primary border-opacity-25">HD Quality</span>
                    </div>
                </div>
                
                <!-- Map Container -->
                <div class="position-relative rounded-4 overflow-hidden mb-4" style="height: 400px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.5), rgba(16, 185, 129, 0.2));">
                    <!-- Simulated Cloud Overlays -->
                    <div class="position-absolute" style="top: 25%; left: 33%; width: 96px; height: 64px; background: rgba(255, 255, 255, 0.4); border-radius: 50px; filter: blur(8px); animation: pulse 3s infinite;"></div>
                    <div class="position-absolute" style="top: 50%; right: 25%; width: 128px; height: 80px; background: rgba(255, 255, 255, 0.3); border-radius: 50px; filter: blur(8px); animation: pulse 3s infinite; animation-delay: 1s;"></div>
                    <div class="position-absolute" style="bottom: 33%; left: 25%; width: 80px; height: 48px; background: rgba(255, 255, 255, 0.35); border-radius: 50px; filter: blur(8px); animation: pulse 3s infinite; animation-delay: 2s;"></div>
                    
                    <!-- User Location Marker -->
                    <div class="position-absolute" style="top: 50%; left: 50%; width: 12px; height: 12px; background: #ef4444; border-radius: 50%; animation: ping 2s infinite;" id="userLocationMarker"></div>
                    
                    <!-- Coordinates Display -->
                    <div class="position-absolute top-0 start-0 m-3 p-2 rounded" style="background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(8px);">
                        <div class="small text-white" id="mapCoordinates">Getting location...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Satellite Info -->
        <div class="col-lg-4">
            <div class="card-glass rounded-4 p-4 h-100">
                <h6 class="text-white mb-3">
                    <i class="fas fa-info-circle text-cyan-400 me-2"></i>
                    Satellite Information
                </h6>
                
                <!-- Satellite Details -->
                <div class="space-y-3">
                    <div class="p-3 rounded" style="background: rgba(255, 255, 255, 0.05);">
                        <div class="small text-white-50">Primary Satellite</div>
                        <div class="text-white fw-medium">INSAT-3DR</div>
                    </div>
                    
                    <div class="p-3 rounded" style="background: rgba(255, 255, 255, 0.05);">
                        <div class="small text-white-50">Orbit Type</div>
                        <div class="text-white fw-medium">Geostationary</div>
                    </div>
                    
                    <div class="p-3 rounded" style="background: rgba(255, 255, 255, 0.05);">
                        <div class="small text-white-50">Altitude</div>
                        <div class="text-white fw-medium">35,786 km</div>
                    </div>
                    
                    <div class="p-3 rounded" style="background: rgba(255, 255, 255, 0.05);">
                        <div class="small text-white-50">Coverage Area</div>
                        <div class="text-white fw-medium">Indian Ocean Region</div>
                    </div>
                    
                    <div class="p-3 rounded" style="background: rgba(255, 255, 255, 0.05);">
                        <div class="small text-white-50">Resolution</div>
                        <div class="text-white fw-medium">4 km (TIR channels)</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Analytics Details Modal -->
<div class="modal fade" id="analyticsModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-dark border-0" style="backdrop-filter: blur(20px); background: rgba(0, 0, 0, 0.85) !important;">
            <div class="modal-header border-bottom border-white border-opacity-20">
                <h5 class="modal-title text-white" id="modalTitle">Analysis Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="text-center">
                            <img id="modalImage" src="" alt="Analysis Result" class="img-fluid rounded-3 mb-3" style="max-height: 300px;">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="space-y-3">
                            <div class="p-3 rounded" style="background: rgba(255, 255, 255, 0.1);">
                                <div class="small text-white-50">File Name</div>
                                <div class="text-white fw-medium" id="modalFileName"></div>
                            </div>
                            
                            <div class="row g-3">
                                <div class="col-6">
                                    <div class="p-3 rounded" style="background: rgba(255, 255, 255, 0.1);">
                                        <div class="small text-white-50">Location</div>
                                        <div class="text-white fw-medium" id="modalLocation"></div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="p-3 rounded" style="background: rgba(255, 255, 255, 0.1);">
                                        <div class="small text-white-50">Cloud Coverage</div>
                                        <div class="text-white fw-medium" id="modalCoverage"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row g-3">
                                <div class="col-6">
                                    <div class="p-3 rounded" style="background: rgba(255, 255, 255, 0.1);">
                                        <div class="small text-white-50">Temperature</div>
                                        <div class="text-white fw-medium" id="modalTemp"></div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="p-3 rounded" style="background: rgba(255, 255, 255, 0.1);">
                                        <div class="small text-white-50">Weather</div>
                                        <div class="text-white fw-medium" id="modalWeather"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="p-3 rounded" style="background: rgba(255, 255, 255, 0.1);">
                                <div class="small text-white-50">Processing Time</div>
                                <div class="text-white fw-medium" id="modalProcessingTime"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-top border-white border-opacity-20">
                <button type="button" class="btn btn-glass-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Close
                </button>
                <button type="button" class="btn btn-glass" id="modalDownloadBtn">
                    <i class="fas fa-download me-2"></i>Download Results
                </button>
                <button type="button" class="btn btn-glass" id="modalViewBtn">
                    <i class="fas fa-eye me-2"></i>View Full Analysis
                </button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for Enhanced Functionality -->
<script>
let userLocation = null;
let weatherApiKey = 'c3834996fdea92c220ef99c40fad146f';



// Tab switching functionality
function showTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(content => {
        content.style.display = 'none';
    });
    
    // Remove active class from all buttons
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(tabName + '-tab').style.display = 'block';
    
    // Add active class to clicked button
    event.target.classList.add('active');
}

// Location and Weather API Integration
function requestLocationPermission() {
    const locationBtn = document.getElementById('locationBtn');
    const locationText = document.getElementById('locationText');
    
    if (navigator.geolocation) {
        locationBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        locationText.textContent = 'Getting location...';
        
        navigator.geolocation.getCurrentPosition(
            (position) => {
                userLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                
                locationBtn.innerHTML = '<i class="fas fa-check text-success"></i>';
                locationText.textContent = `${userLocation.lat.toFixed(2)}°, ${userLocation.lng.toFixed(2)}°`;
                
                // Update map coordinates
                document.getElementById('mapCoordinates').textContent = 
                    `Lat: ${userLocation.lat.toFixed(2)}°, Lon: ${userLocation.lng.toFixed(2)}°`;
                
                // Fetch weather data
                fetchWeatherData();
            },
            (error) => {
                locationBtn.innerHTML = '<i class="fas fa-exclamation-triangle text-warning"></i>';
                locationText.textContent = 'Location access denied';
                console.error('Location error:', error);
            }
        );
    } else {
        locationText.textContent = 'Geolocation not supported';
    }
}

function fetchWeatherData() {
    if (!userLocation || !weatherApiKey) {
        return;
    }
    
    const url = `https://api.openweathermap.org/data/2.5/weather?lat=${userLocation.lat}&lon=${userLocation.lng}&appid=${weatherApiKey}&units=metric`;
    
    fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            data._source = 'api'; // Mark as real API data
            updateWeatherDisplay(data);
        })
        .catch(error => {
            // Fallback to mock data if API fails
            const mockWeatherData = {
                main: {
                    temp: 28.5,
                    humidity: 76,
                    pressure: 1012
                },
                wind: {
                    speed: 12.5
                },
                clouds: {
                    all: 85
                },
                weather: [{
                    main: "Clouds",
                    description: "Partly cloudy (Mock Data - API Failed)"
                }],
                name: "Your Location",
                _source: 'mock'
            };
            updateWeatherDisplay(mockWeatherData);
        });
}

function updateWeatherDisplay(data) {
    document.getElementById('weatherTemp').textContent = `${data.main.temp.toFixed(1)}°C`;
    document.getElementById('weatherHumidity').textContent = `${data.main.humidity}%`;
    document.getElementById('weatherPressure').textContent = `${data.main.pressure} hPa`;
    document.getElementById('weatherWind').textContent = `${data.wind.speed.toFixed(1)} km/h`;
    document.getElementById('weatherClouds').textContent = `${data.clouds.all}%`;
    document.getElementById('weatherDescription').textContent = data.weather[0].description;
    document.getElementById('weatherLocation').textContent = data.name;
    document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
    
    // Add visual indicator for data source
    const statusElement = document.querySelector('#weatherLocation');
    if (data._source === 'api') {
        statusElement.style.color = '#10b981'; // Green for real API
        statusElement.title = 'Real-time data from OpenWeatherMap';
    } else {
        statusElement.style.color = '#f59e0b'; // Orange for mock data
        statusElement.title = 'Mock data (API failed or not available)';
    }
}

// File upload functionality with large file support
let selectedFile = null;

// Drag and drop handlers
function handleDragOver(event) {
    event.preventDefault();
    event.currentTarget.classList.add('border-success');
}

function handleDrop(event) {
    event.preventDefault();
    event.currentTarget.classList.remove('border-success');
    const files = event.dataTransfer.files;
    if (files.length > 0) {
        handleFileSelect({ target: { files: files } });
    }
}

function handleFileSelect(event) {
    const file = event.target.files[0];
    selectedFile = file;
    
    if (file) {
        // Validate file type
        const allowedTypes = ['.h5', '.hdf5', '.nc', '.netcdf'];
        const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
        
        if (!allowedTypes.includes(fileExtension)) {
            alert('Please select a valid file type: HDF5 (.h5, .hdf5) or NetCDF (.nc, .netcdf)');
            return;
        }
        
        // Validate file size (500MB max)
        const maxSize = 500 * 1024 * 1024; // 500MB
        if (file.size > maxSize) {
            alert('File size exceeds 500MB limit. Please select a smaller file.');
            return;
        }
        
        // Show file info
        document.getElementById('fileInfo').style.display = 'block';
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('fileSize').textContent = `${(file.size / 1024 / 1024).toFixed(2)} MB`;
        
        // Update drag area
        const uploadArea = document.querySelector('.upload-area');
        uploadArea.style.border = '2px solid #10b981';
        uploadArea.style.background = 'rgba(16, 185, 129, 0.1)';
        uploadArea.querySelector('.upload-content').innerHTML = `
            <i class="fas fa-check-circle text-success fa-3x mb-3"></i>
            <h6 class="text-white">File selected: ${file.name}</h6>
            <p class="text-white-50 small">Ready to upload • ${(file.size / 1024 / 1024).toFixed(2)} MB</p>
        `;
    }
}

// Handle upload submission
async function handleUploadSubmit(event) {
    event.preventDefault();
    
    if (!selectedFile) {
        alert('Please select a file first');
        return;
    }
    
    const formData = new FormData();
    formData.append('file_path', selectedFile);
    formData.append('satellite_name', document.querySelector('[name=satellite_name]').value);
    formData.append('data_type', document.querySelector('[name=data_type]').value);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    const uploadStatus = document.getElementById('uploadStatus');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    
    try {
        uploadStatus.textContent = 'Uploading...';
        
        // Use XMLHttpRequest for progress tracking
        const xhr = new XMLHttpRequest();
        
        xhr.upload.addEventListener('progress', (e) => {
            if (e.lengthComputable) {
                const percentComplete = (e.loaded / e.total) * 100;
                progressBar.style.width = percentComplete + '%';
                progressText.textContent = Math.round(percentComplete) + '%';
            }
        });
        
        xhr.onload = function() {
            if (xhr.status === 200) {
                const result = JSON.parse(xhr.responseText);
                uploadStatus.textContent = 'Upload complete! Processing started...';
                
                // Add to processing queue visually
                addToProcessingQueue(selectedFile.name);
                
                // Reset form after 2 seconds
                setTimeout(() => {
                    resetUploadForm();
                    if (result.redirect_url) {
                        window.location.href = result.redirect_url;
                    }
                }, 2000);
            } else {
                throw new Error('Upload failed');
            }
        };
        
        xhr.onerror = function() {
            throw new Error('Upload failed');
        };
        
        xhr.open('POST', '/upload/');
        xhr.send(formData);
        
    } catch (error) {
        console.error('Upload error:', error);
        uploadStatus.textContent = 'Upload failed: ' + error.message;
        progressBar.style.width = '0%';
        progressText.textContent = '';
    }
}

// Add file to processing queue visually
function addToProcessingQueue(fileName) {
    const queueDiv = document.getElementById('processingQueue');
    
    // Remove "No files in queue" message if present
    const emptyMessage = queueDiv.querySelector('.text-center');
    if (emptyMessage) {
        emptyMessage.remove();
    }
    
    // Add new processing item
    const newItem = document.createElement('div');
    newItem.className = 'd-flex justify-content-between align-items-center p-2 mb-2 rounded';
    newItem.style.background = 'rgba(255, 255, 255, 0.05)';
    newItem.innerHTML = `
        <div>
            <div class="text-white small fw-medium">${fileName.length > 20 ? fileName.substring(0, 20) + '...' : fileName}</div>
            <div class="text-white-50 small">Just now</div>
        </div>
        <div>
            <span class="badge bg-warning bg-opacity-25 text-warning">
                <i class="fas fa-spinner fa-spin me-1"></i>Processing
            </span>
        </div>
    `;
    
    queueDiv.insertBefore(newItem, queueDiv.firstChild);
}

// Reset upload form
function resetUploadForm() {
    selectedFile = null;
    document.getElementById('fileInput').value = '';
    document.getElementById('fileInfo').style.display = 'none';
    document.getElementById('uploadProgress').style.display = 'none';
    
    // Reset upload area
    const uploadArea = document.querySelector('.upload-area');
    uploadArea.style.border = '';
    uploadArea.style.background = '';
    uploadArea.querySelector('.upload-content').innerHTML = `
        <i class="fas fa-cloud-upload-alt text-primary fa-3x mb-3"></i>
        <h6 class="text-white">Drag & Drop your satellite data file here</h6>
        <p class="text-white-50 small">or click to browse</p>
        <div class="small text-white-50">
            Supported: HDF5 (.h5, .hdf5), NetCDF (.nc, .netcdf) • Max: 500MB
        </div>
    `;
    
    // Reset button
    const uploadBtn = document.getElementById('uploadBtn');
    uploadBtn.disabled = false;
    uploadBtn.innerHTML = '<i class="fas fa-cloud-upload-alt me-2"></i>Upload & Process';
}

// Initialize file input handler
document.getElementById('fileInput').addEventListener('change', handleFileSelect);

// Analytics card modal functionality
function showAnalyticsDetails(dataId) {
    // Fetch data from correct API endpoint
    fetch(`/api/analytics-data/${dataId}/`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            document.getElementById('modalTitle').textContent = `Analysis: ${data.file_name}`;
            document.getElementById('modalImage').src = data.image_url;
            document.getElementById('modalFileName').textContent = data.file_name;
            document.getElementById('modalLocation').textContent = data.location_name;
            document.getElementById('modalCoverage').textContent = `${data.cloud_coverage}%`;
            document.getElementById('modalTemp').textContent = `${data.temperature}K`;
            document.getElementById('modalWeather').textContent = data.weather_conditions;
            document.getElementById('modalProcessingTime').textContent = data.processing_time;
            
            // Set up download and view buttons
            document.getElementById('modalDownloadBtn').onclick = () => {
                // Download multiple files
                setTimeout(() => {
                    window.open(`/download/${dataId}/bt_plot/`, '_blank');
                }, 100);
                setTimeout(() => {
                    window.open(`/download/${dataId}/results/`, '_blank');
                }, 300);
            };
            document.getElementById('modalViewBtn').onclick = () => {
                window.location.href = `/results/${dataId}/`;
            };
            
            // Show modal
            const modalElement = document.getElementById('analyticsModal');
            const modal = new bootstrap.Modal(modalElement, {
                backdrop: 'static',  // Prevent closing on backdrop click
                keyboard: true       // Allow closing with Escape key
            });
            
                        modal.show();
        })
        .catch(error => {
            // Show error message in modal
            document.getElementById('modalTitle').textContent = 'Error Loading Data';
            document.getElementById('modalImage').src = '';
            document.getElementById('modalFileName').textContent = 'Error';
            document.getElementById('modalLocation').textContent = 'Failed to load';
            document.getElementById('modalCoverage').textContent = 'N/A';
            document.getElementById('modalTemp').textContent = 'N/A';
            document.getElementById('modalWeather').textContent = 'Error';
            document.getElementById('modalProcessingTime').textContent = 'Failed';
            
            // Still show the modal with error message
            const errorModal = new bootstrap.Modal(document.getElementById('analyticsModal'));
            errorModal.show();
        });
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Request location permission automatically
    setTimeout(requestLocationPermission, 1000);
    
    // Update weather data every 30 seconds
    setInterval(function() {
        if (userLocation) {
            fetchWeatherData();
        }
    }, 30000);
});
</script>

<!-- Custom CSS for animations -->
<style>
.analytics-card {
    transition: all 0.3s ease;
}

.analytics-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
}

.upload-area {
    transition: all 0.3s ease;
}

.upload-area:hover {
    border-color: rgba(59, 130, 246, 0.7) !important;
    background: rgba(59, 130, 246, 0.15) !important;
}

@keyframes pulse {
    0%, 100% { opacity: 0.7; }
    50% { opacity: 1; }
}

@keyframes ping {
    0% { transform: scale(1); opacity: 1; }
    75%, 100% { transform: scale(2); opacity: 0; }
}

.btn-glass-secondary {
    background: rgba(108, 117, 125, 0.2);
    border: 1px solid rgba(108, 117, 125, 0.3);
    color: #6c757d;
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
}

.btn-glass-secondary:hover {
    background: rgba(108, 117, 125, 0.3);
    border-color: rgba(108, 117, 125, 0.5);
    color: #6c757d;
    transform: translateY(-2px);
}

/* Modal Accessibility Fix - Ensures buttons are clickable */
.modal-footer button {
    pointer-events: auto !important;
    cursor: pointer !important;
}

/* Modal Fix - Ensures proper interaction */
.modal-backdrop {
    pointer-events: none !important;
}

.modal-content {
    pointer-events: auto !important;
}


</style>
{% endblock %} 