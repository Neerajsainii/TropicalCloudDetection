{% extends 'cloud_detection/modern_base.html' %}

{% block title %}Dashboard - TropicalSat Cloud Detection{% endblock %}

{% block content %}
<!-- Tab Navigation -->
<div class="mb-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex flex-column flex-md-row gap-2 justify-content-center">
                <button class="tab-button btn flex-fill me-md-2 mb-2 mb-md-0 active" onclick="showTab('dashboard')">
                    <i class="fas fa-chart-bar me-2"></i>
                    Dashboard
                </button>
                <button class="tab-button btn flex-fill me-md-2 mb-2 mb-md-0" onclick="showTab('upload')">
                    <i class="fas fa-upload me-2"></i>
                    Upload Data
                </button>
                <button class="tab-button btn flex-fill" onclick="showTab('satellite')">
                    <i class="fas fa-satellite me-2"></i>
                    Satellite View
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Dashboard Tab Content -->
<div id="dashboard-tab" class="tab-content">
    <div class="row g-4">
        <!-- Analytics Section -->
        <div class="col-lg-8">
            <div class="card-glass rounded-4 p-4 h-100">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="text-white mb-0">
                        <i class="fas fa-chart-bar text-cyan-400 me-2"></i>
                        Cloud Analytics Dashboard
                    </h5>
                    <div class="d-flex gap-2">
                        <span class="badge bg-primary bg-opacity-25 text-primary border border-primary border-opacity-25">24H Data</span>
                        <span class="badge bg-success bg-opacity-25 text-success border border-success border-opacity-25">Real-time</span>
                    </div>
                </div>
                
                <!-- Stats Cards -->
                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <div class="p-3 rounded-3" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(6, 182, 212, 0.2)); border: 1px solid rgba(59, 130, 246, 0.3);">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <p class="text-primary-light small mb-1">Total Files</p>
                                    <p class="h4 text-primary fw-bold mb-0">{{ total_files|default:"0" }}</p>
                                </div>
                                <div class="p-2 rounded-circle" style="background: rgba(59, 130, 246, 0.3);">
                                    <i class="fas fa-file-alt text-primary"></i>
                                </div>
                            </div>
                            <div class="small text-primary-light mt-2">Your uploaded files</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="p-3 rounded-3" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(20, 184, 166, 0.2)); border: 1px solid rgba(16, 185, 129, 0.3);">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <p class="text-success-light small mb-1">Completed</p>
                                    <p class="h4 text-success fw-bold mb-0">{{ completed_files|default:"0" }}</p>
                                </div>
                                <div class="p-2 rounded-circle" style="background: rgba(16, 185, 129, 0.3);">
                                    <i class="fas fa-check-circle text-success"></i>
                                </div>
                            </div>
                            <div class="small text-success-light mt-2">Successfully processed</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="p-3 rounded-3" style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(236, 72, 153, 0.2)); border: 1px solid rgba(168, 85, 247, 0.3);">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <p class="text-purple-light small mb-1">Processing</p>
                                    <p class="h4 text-purple fw-bold mb-0 status-value" data-type="processing_count">0</p>
                                </div>
                                <div class="p-2 rounded-circle" style="background: rgba(168, 85, 247, 0.3);">
                                    <i class="fas fa-cog fa-spin text-purple"></i>
                                </div>
                            </div>
                            <div class="small text-purple-light mt-2">Currently processing</div>
                        </div>
                    </div>
                </div>
                
                <!-- Chart Area -->
                <div class="chart-container">
                    <canvas id="analyticsChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="col-lg-4">
            <div class="row g-4">
                <!-- Recent Activity -->
                <div class="col-12">
                    <div class="card-glass rounded-4 p-4">
                        <h6 class="text-white mb-3">
                            <i class="fas fa-history text-cyan-400 me-2"></i>
                            Recent Activity
                        </h6>
                        {% if recent_results %}
                        <div class="space-y-3">
                            {% for data in recent_results %}
                            <div class="d-flex align-items-center p-3 rounded-3" style="background: rgba(255, 255, 255, 0.05);">
                                <div class="flex-shrink-0 me-3">
                                    <div class="p-2 rounded-circle" style="background: rgba(6, 182, 212, 0.2);">
                                        <i class="fas fa-file-alt text-cyan-400"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <p class="text-white small mb-1">{{ data.file_name|truncatechars:25 }}</p>
                                    <p class="text-white-75 small mb-0">{{ data.upload_datetime|date:"M d, H:i" }}</p>
                                </div>
                                <div class="flex-shrink-0">
                                    <span class="badge {% if data.status == 'completed' %}bg-success{% elif data.status == 'processing' %}bg-warning{% else %}bg-secondary{% endif %}">
                                        {{ data.status|title }}
                                    </span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-inbox text-white-50 fs-1 mb-3"></i>
                            <p class="text-white-75">No recent activity</p>
                            <p class="text-white-50 small">Upload your first file to get started</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="col-12">
                    <div class="card-glass rounded-4 p-4">
                        <h6 class="text-white mb-3">
                            <i class="fas fa-bolt text-cyan-400 me-2"></i>
                            Quick Actions
                        </h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-glass" onclick="showTab('upload')">
                                <i class="fas fa-upload me-2"></i>Upload New File
                            </button>
                            <a href="{% url 'cloud_detection:data_history' %}" class="btn btn-glass">
                                <i class="fas fa-history me-2"></i>View All Data
                            </a>
                            <a href="{% url 'cloud_detection:about' %}" class="btn btn-glass">
                                <i class="fas fa-info-circle me-2"></i>About System
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Processed Files Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card-glass rounded-4 p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="text-white mb-0">
                        <i class="fas fa-cloud text-cyan-400 me-2"></i>
                        Your Processed Files
                    </h5>
                    <div class="d-flex gap-2">
                        <span class="badge bg-info bg-opacity-25 text-info border border-info border-opacity-25">{{ total_files|default:"0" }} Files</span>
                    </div>
                </div>
                
                {% if recent_results %}
                <div class="row g-4">
                    {% for data in recent_results %}
                    <div class="col-lg-4 col-md-6">
                        <div class="card-glass rounded-4 p-4 h-100" style="border: 1px solid rgba(255, 255, 255, 0.1);">
                            <!-- File Header -->
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div class="d-flex align-items-center">
                                    <div class="p-2 rounded-circle me-3" style="background: rgba(6, 182, 212, 0.2);">
                                        <i class="fas fa-file-alt text-cyan-400"></i>
                                    </div>
                                    <div>
                                        <h6 class="text-white mb-1">{{ data.file_name|truncatechars:20 }}</h6>
                                        <small class="text-white-75">{{ data.upload_datetime|date:"M d, Y H:i" }}</small>
                                    </div>
                                </div>
                                <span class="badge {% if data.status == 'completed' %}bg-success{% elif data.status == 'processing' %}bg-warning{% elif data.status == 'failed' %}bg-danger{% else %}bg-secondary{% endif %}">
                                    {{ data.status|title }}
                                </span>
                            </div>
                            
                            <!-- File Details -->
                            <div class="mb-3">
                                <div class="row g-2">
                                    <div class="col-6">
                                        <small class="text-white-50">Satellite:</small>
                                        <p class="text-white small mb-0">{{ data.satellite_name|default:"INSAT" }}</p>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-white-50">Type:</small>
                                        <p class="text-white small mb-0">{{ data.data_type|default:"HDF5" }}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Processing Results -->
                            {% if data.status == 'completed' %}
                            <div class="mb-3">
                                <div class="row g-2">
                                    {% if data.cloud_coverage_percentage %}
                                    <div class="col-6">
                                        <small class="text-white-50">Cloud Coverage:</small>
                                        <p class="text-success small mb-0">{{ data.cloud_coverage_percentage|floatformat:1 }}%</p>
                                    </div>
                                    {% endif %}
                                    {% if data.avg_temperature %}
                                    <div class="col-6">
                                        <small class="text-white-50">Avg Temp:</small>
                                        <p class="text-info small mb-0">{{ data.avg_temperature|floatformat:1 }}°C</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Action Buttons -->
                            <div class="d-flex gap-2">
                                {% if data.status == 'completed' %}
                                <a href="{% url 'cloud_detection:view_results' data.id %}" class="btn btn-sm btn-glass flex-fill">
                                    <i class="fas fa-eye me-1"></i>View Results
                                </a>
                                {% elif data.status == 'processing' %}
                                <button class="btn btn-sm btn-glass flex-fill" disabled>
                                    <i class="fas fa-cog fa-spin me-1"></i>Processing
                                </button>
                                {% else %}
                                <button class="btn btn-sm btn-glass flex-fill" onclick="retryProcessing({{ data.id }})">
                                    <i class="fas fa-redo me-1"></i>Retry
                                </button>
                                {% endif %}
                                
                                <button class="btn btn-sm btn-glass" onclick="deleteFile({{ data.id }})" title="Delete File">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- View All Button -->
                <div class="text-center mt-4">
                    <a href="{% url 'cloud_detection:data_history' %}" class="btn btn-glass">
                        <i class="fas fa-list me-2"></i>View All Files
                    </a>
                </div>
                
                {% else %}
                <!-- Empty State -->
                <div class="text-center py-5">
                    <div class="d-flex align-items-center justify-content-center mb-4 rounded-circle mx-auto" 
                         style="width: 100px; height: 100px; background: linear-gradient(135deg, rgba(6, 182, 212, 0.2), rgba(59, 130, 246, 0.2));">
                        <i class="fas fa-cloud-upload-alt text-cyan-400 fs-1"></i>
                    </div>
                    <h5 class="text-white mb-3">No Processed Files Yet</h5>
                    <p class="text-white-75 mb-4">Upload your first satellite data file to start cloud detection analysis</p>
                    <button class="btn btn-lg" onclick="showTab('upload')" 
                            style="background: linear-gradient(135deg, #3b82f6, #06b6d4); border: none;">
                        <i class="fas fa-upload me-2"></i>Upload Your First File
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Upload Tab Content -->
<div id="upload-tab" class="tab-content" style="display: none;">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card-glass rounded-4 p-4">
                <div class="text-center mb-4">
                    <div class="d-flex align-items-center justify-content-center mb-3 rounded-circle mx-auto" 
                         style="width: 80px; height: 80px; background: linear-gradient(135deg, #3b82f6, #06b6d4);">
                        <i class="fas fa-cloud-upload-alt text-white fs-3"></i>
                    </div>
                    <h4 class="text-white fw-bold">Upload Satellite Data</h4>
                    <p class="text-white-75">Upload your satellite data files for cloud detection analysis</p>
                </div>
                
                <form method="post" enctype="multipart/form-data" id="uploadForm">
                    {% csrf_token %}
                    <div class="mb-4">
                        <label for="{{ form.file_path.id_for_label }}" class="form-label text-white">Select Satellite Data File</label>
                        {{ form.file_path }}
                        {% if form.file_path.errors %}
                            <div class="text-danger mt-2">
                                {% for error in form.file_path.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text text-white-50">Supported formats: .h5, .hdf5, .nc, .netcdf (max 200MB)</div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.satellite_name.id_for_label }}" class="form-label text-white">Satellite Name</label>
                            {{ form.satellite_name }}
                            {% if form.satellite_name.errors %}
                                <div class="text-danger mt-2">
                                    {% for error in form.satellite_name.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.data_type.id_for_label }}" class="form-label text-white">Data Type</label>
                            {{ form.data_type }}
                            {% if form.data_type.errors %}
                                <div class="text-danger mt-2">
                                    {% for error in form.data_type.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <button type="submit" class="btn btn-lg" id="uploadBtn"
                                style="background: linear-gradient(135deg, #3b82f6, #06b6d4); border: none;">
                            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            <i class="fas fa-upload me-2"></i>Upload and Process
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Satellite View Tab Content -->
<div id="satellite-tab" class="tab-content" style="display: none;">
    <div class="row">
        <div class="col-12">
            <div class="card-glass rounded-4 p-4">
                <div class="text-center">
                    <div class="d-flex align-items-center justify-content-center mb-3 rounded-circle mx-auto" 
                         style="width: 80px; height: 80px; background: linear-gradient(135deg, #10b981, #14b8a6);">
                        <i class="fas fa-satellite text-white fs-3"></i>
                    </div>
                    <h4 class="text-white fw-bold">Satellite View</h4>
                    <p class="text-white-75">Real-time satellite data visualization and monitoring</p>
                </div>
                
                <div class="row g-4 mt-4">
                    <div class="col-md-6">
                        <div class="card-glass rounded-4 p-4">
                            <h6 class="text-white mb-3">
                                <i class="fas fa-globe text-cyan-400 me-2"></i>
                                Coverage Map
                            </h6>
                            <div class="text-center py-4">
                                <i class="fas fa-map text-white-50 fs-1 mb-3"></i>
                                <p class="text-white-75">Interactive coverage map coming soon</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card-glass rounded-4 p-4">
                            <h6 class="text-white mb-3">
                                <i class="fas fa-signal text-cyan-400 me-2"></i>
                                Signal Status
                            </h6>
                            <div class="d-flex align-items-center justify-content-between mb-3">
                                <span class="text-white">INSAT-3D</span>
                                <span class="badge bg-success">Active</span>
                            </div>
                            <div class="d-flex align-items-center justify-content-between mb-3">
                                <span class="text-white">MODIS</span>
                                <span class="badge bg-success">Active</span>
                            </div>
                            <div class="d-flex align-items-center justify-content-between">
                                <span class="text-white">GOES-16</span>
                                <span class="badge bg-warning">Maintenance</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart Script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('analyticsChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['00:00', '03:00', '06:00', '09:00', '12:00', '15:00', '18:00', '21:00'],
            datasets: [{
                label: 'Cloud Coverage (%)',
                data: [65, 72, 68, 75, 80, 78, 70, 65],
                borderColor: '#06b6d4',
                backgroundColor: 'rgba(6, 182, 212, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: 'rgba(255, 255, 255, 0.8)'
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.6)'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                },
                y: {
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.6)'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                }
            }
        }
    });
});

// Retry processing function
function retryProcessing(fileId) {
    if (confirm('Are you sure you want to retry processing this file?')) {
        window.location.href = `/retry-processing/${fileId}/`;
    }
}

// Delete file function
function deleteFile(fileId) {
    if (confirm('Are you sure you want to delete this file? This action cannot be undone.')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/delete/${fileId}/`;
        
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken;
        
        form.appendChild(csrfInput);
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %} 